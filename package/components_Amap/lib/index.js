import{reactive as e,provide as t,h as o,inject as n,ref as a,watch as i,nextTick as l,onMounted as u}from"vue";const r={Map:{name:"Map",props:{name:{type:String,default:()=>"AMap"},zoom:{type:Number,default:()=>13},center:{type:Array,default:()=>[116.397428,39.90923]},viewMode:{type:String,default:"2D"},id:{type:String,default:"MapDom"}},setup(n,a){const i=e({map:{},isReady:!1});return t("storeData",i),function(){let e="";if("AMap"===n.name)e="https://webapi.amap.com/maps?v=2.1Beta&key=966a1cec27bf619fc0b3d8683e8f4c01&plugin=AMap.MarkerCluster";(t=n.name,o=e,window[t]?window[t]._preloader?window[t]._preloader:Promise.resolve(window[t]):(window[t]={},window[t]._preloader=new Promise((function(e,n){window._initMap=function(){e(window[t]),window[t]._preloader=null,window._initMap=null};var a=document.createElement("script");a.type="text/javascript",window.document.body.appendChild(a),a.src=o+"&callback=_initMap"})),window[t]._preloader)).then((e=>{!function(e){i.map=new e.Map(n.id,{zoom:n.zoom,center:n.center,viewMode:n.viewMode}),i.isReady=!0}(e)}));var t,o}(),console.log(a.slots,"contex.slots"),()=>o("div",{class:"Map",id:n.id,style:{height:"500px"}},o("div",{},i.isReady&&a.slots.default?a.slots.default():""))}},Marker:{name:"Marker",props:{position:{type:Array,default:()=>[]},size:{type:Array,default:()=>[32,32]},id:null,Icon:{type:String||null,default:null},usemoveTransform:{type:Boolean,default:()=>!1}},emits:["click","moving"],setup(e,t){const o=n("storeData"),{map:u}=o,r=a();function s(){e.position.length&&(console.log(e.size,"initMakrt"),r.value=new window.AMap.Marker({map:u,position:e.position,icon:e.Icon,size:new window.AMap.Size(e.size[0],e.size[1])}),r.value.id=e.id,r.value.on("click",d),r.value.on("moving",v))}function p(){console.log("removeMarker"),r.value&&(r.value.off("click",d),r.value.off("moving",v),u.remove(r.value),r.value=null)}function d(o){t.emit("click",{id:e.id,lnglat:e.position})}function v(o){t.emit("moving",{id:e.id,lnglat:o.target._position})}return s(),i((()=>e.position),(function(t){if(!r.value)return s();if(!t.length)return p();!function(t,o=1e3){console.log(t,"setPosition"),e.usemoveTransform?r.value.moveTo(t,{duration:o,delay:500}):r.value.setPosition(t)}(t)}),{immediate:!0,deep:!0}),i((()=>e.Icon),(function(e,t){if(!r.value)return;e!=t&&r.value.setIcon(e)}),{immediate:!0,deep:!0}),l((()=>{})),{removeMarker:p,myMarker:r}},render:()=>()=>o("div",{class:"Marwwker"})},Liner:{name:"Liner",props:{path:{type:Array,default:()=>[]},options:{type:Object,default:()=>({borderWeight:2,strokeColor:"#28F"})}},setup(e){const t=n("storeData");console.log(t,"storeData");const{map:o}=t,l=a();function u(e,t){}return l.value=new window.AMap.Polyline({map:o,...e.options}),l.value.on("click",u),i((()=>e.path),(function(t){t.length&&l.value.setPath(e.path)}),{immediate:!0,deep:!0}),{removeMarker:function(){l.value&&(l.value.off("click",u),o.remove(l.value),l.value=null)},myLiner:l}},render:()=>()=>o("div",{class:"Liner"},"Liner")},InfoWindow:{name:"InfoWindow",props:{position:{type:Array,default:()=>[]},content:null},emits:["close"],setup(e,t){const o=n("storeData"),{map:l}=o,r=a();function s(){e.position.length?t.emit("close"):console.log("手动调用")}function p(){r.value.setContent(e.content)}return r.value=new window.AMap.InfoWindow({offset:new window.AMap.Pixel(0,-30),autoMove:!0}),r.value.id=e.id,r.value.on("close",s),u((()=>{console.log("InfoWindow")})),i((()=>e.position),(function(t){r.value&&t.length&&(r.value.getIsOpen()?(o=t,p(),r.value.setPosition(o)):(p(),r.value.open(l,e.position)));var o}),{immediate:!0,deep:!0}),i((()=>e.content),(function(e){r.value.setContent(e)}),{immediate:!0,deep:!0}),{close:function(){r.value.close()}}},render:()=>()=>o("div",{class:"InfoWindow"},"InfoWindow")},MouseTool:{name:"MouseTool",props:{type:{type:String,default:"marker"}},emits:["draw"],setup(e,t){const o=n("storeData"),{map:l}=o,u=a(),r=a([{}]);function s(o){console.log(e.type,o),r.value.push(o.obj),t.emit("draw",{obj:o.obj,overlays:r.value})}return l.plugin(["AMap.MouseTool"],(function(){u.value=new window.AMap.MouseTool(l)})),i((()=>e.type),(function(e){console.log(e,"watchType"),e&&e!=u.value&&(u.value[e](),u.value.on("draw",s))}),{immediate:!0,deep:!0}),{remove:function(){l.remove(r.value)},close:function(e=!0){u.value.close(e)}}},render:()=>()=>o("div",{class:"MouseTool"},"MouseTool")},PathSimplifierIns:{name:"PathSimplifierIns",props:{model:{type:String,default:()=>"realTime"},icon:{type:String||null,default:""},id:null,position:{type:Array,default:()=>[]},speed:{type:Number,default:0}},emits:["moveing","pointClick"],setup(e,t){const o=n("storeData");console.log(o,"storeData");const{map:l}=o,r=a();r.value=null;const s=a(),p={lineWidth:0,fillStyle:null,strokeStyle:null,borderStyle:null},d=a(),v=a([{name:"动态路线",path:[[]]}]),c=a(0);var m,f;function w(){r.value=new s.value({zIndex:100,autoSetFitView:!1,map:l,pathNavigatorStyle:{width:32,height:32,content:s.value.Render.Canvas.getImageContent(e.icon)},getPath:function(e){return e.path},getHoverTitle:function(e){return e.name+"，点数量"+e.path.length},renderOptions:"realTime"==e.model?{pathLineStyle:p,pathLineSelectedStyle:p,pathLineHoverStyle:p,keyPointStyle:p,startPointStyle:p,endPointStyle:p,keyPointHoverStyle:p,keyPointOnSelectedPathLineStyle:p}:{}})}function g(o,n){let a=n.dataItem.pointIndex,i=d.value.getPosition();if(t.emit("moveing",[i.lng,i.lat]),"realTime"==e.model);else{if(!e.position[c.value].icon)return;if(c.value!=a){c.value=a,d.value.getStyleOptions().content=s.value.Render.Canvas.getImageContent(e.position[c.value].icon),r.value.renderLater(200)}}}function y(e,o){t.emit("pointClick",e,o)}function h(t){r.value?"realTime"==e.model&&(d.value?function(t){if(t.length){var o=d.value.getCursor().clone(),n=d.value.getNaviStatus();v.value[0].path[0].length?v.value[0].path.push(t):v.value[0].path[0]=t,r.value.setData(v.value),d.value=r.value.createPathNavigator(0,{speed:e.speed||1e6,pathNavigatorStyle:{width:32,height:32,content:s.value.Render.Canvas.getImageContent(e.icon)}}),d.value.on("move",g),"stop"!==n&&d.value.start(),o.idx>=0&&d.value.moveToPoint(o.idx,o.tail)}}(t):(v.value[0].path[0]=e.position,r.value.setData(v.value),d.value=r.value.createPathNavigator(0,{speed:e.speed||1e6,loop:!1,pathNavigatorStyle:{width:32,height:32,content:s.value.Render.Canvas.getImageContent(e.icon)}}),d.value.start())):setTimeout((()=>{"realTime"==e.model?h(t):h(null)}),200)}function M(){d.value.destroy()}return(m="AMapUI",f="https://webapi.amap.com/ui/1.1/main.js?v=1.1.1",window[m]?window[m]._preloader?window[m]._preloader:Promise.resolve(window[m]):(window[m]={},window[m]._preloader=new Promise(((e,t)=>{const o=document.createElement("script");o.src=f,window.document.body.appendChild(o),o.onload=function(){e(window[m]),window[m]._preloader=null}})),window[m]._preloader)).then((e=>{!function(e){e.load(["ui/misc/PathSimplifier"],(function(e){e.supportCanvas?(s.value=e,w()):alert("当前环境不支持 Canvas！")}))}(e)})),u((()=>{})),i((()=>e.id),(function(t,o){if(!o)return;d.value&&M(),d.value=null,"realTime"==e.model&&t&&(v.value[0].path=[e.position],w())}),{immediate:!0,deep:!0}),i((()=>e.position),(function(e){if(!e[0])return;h(e)}),{immediate:!0,deep:!0}),{start:function(){!function(){let t=[];if(e.position[0].point&&(t=e.position.map((e=>e.point))),e.position[0].length&&(t=e.position),console.log(t,"historyStart"),t[0]){let o=e.position[0].icon||e.icon;console.log(e.position,"historyStart"),v.value[0].path=t,r.value.setData(v.value),d.value=r.value.createPathNavigator(0,{loop:!1,speed:e.speed||1e6,pathNavigatorStyle:{width:32,height:32,content:s.value.Render.Canvas.getImageContent(o)},getPath:function(e){return e.path}}),d.value.start(),d.value.on("move",g),r.value.off("pathClick pointClick",y)}}()},pause:function(){d.value.pause()},resume:function(){d.value.resume()},stop:function(){d.value.stop()},destroy:M}},render:()=>()=>o("div",{class:"MoveAnimation"},"MoveAnimation")},MoveAnimation:{name:"MoveAnimation",props:{lineArr:{type:Array,default:()=>[]}},setup(e,t){const o=n("storeData"),{map:l}=o,u=a();return i((()=>e.lineArr),(function(t){t[0]&&(console.log(e.lineArr[0],"props.lineArr"),window.AMap.plugin("AMap.MoveAnimation",(function(){u.value=new window.AMap.Marker({map:l,position:e.lineArr[0],icon:"https://a.amap.com/jsapi_demos/static/demo-center-v2/car.png"});let t=new window.AMap.Polyline({map:l,strokeColor:"#AF5",strokeWeight:6});u.value.on("moving",(function(e){t.setPath(e.passedPath)})),l.setFitView()})))}),{immediate:!0,deep:!0}),{startAnimation:function(){u.value.moveAlong(e.lineArr,{duration:500,autoRotation:!0})},pauseAnimation:function(){u.value.pauseMove()},resumeAnimation:function(){u.value.resumeMove()},stopAnimation:function(){u.value.stopMove()}}},render:()=>()=>o("div",{class:"MoveAnimation"},"MoveAnimation")},EditPlugin:{name:"EditPlugin",props:{type:{type:String,default:""},edit:{type:Boolean,default:!1},overlayOptions:{type:Object,default:()=>({})}},emits:["end"],setup(e,t){const o=n("storeData"),{map:l}=o,u=a(""),r=a(),s=a();function p(){if(!u.value)return;console.log(u.value,"createOverlayeditType Circle");let t={};"rectangle"==e.type&&(t.bounds=new window.AMap.Bounds(e.overlayOptions.southWest,e.overlayOptions.northEast)),r.value=new window.AMap[u.value]({...e.overlayOptions,...t}),r.value.setMap(l),e.edit&&d()}function d(){if(u.value)return"marker"==e.type?r.value.setDraggable(!0):void l.plugin(["AMap."+u.value+"Editor"],(function(){s.value=new window.AMap[u.value+"Editor"](l,r.value),s.value.open(),s.value.on("end",v)}))}function v(e){t.emit("end",e)}console.log(e,"EditPlugin"),i((()=>e.edit),(function(t){if(console.log(t,"watchEdit"),!e.type)return;t?r.value?d():p():s.value&&s.value.close()}),{immediate:!0,deep:!0}),i((()=>e.type),(function(e){if(function(){r.value&&(l.remove(r.value),r.value=null,console.log(r.value,"myoverlay"));s.value&&(s.value.close(),s.value.off("end",v),s.value=null)}(),e){let t=e.split("");t[0]=t[0].toUpperCase(),u.value=t.join(""),p()}}),{immediate:!0,deep:!0})},render:()=>()=>o("div",{class:"EditPlugin"},"EditPlugin")}};let s={version:"0.0.1",install:function(e){for(var t in r)e.component(t,r[t])},...r};export{s as default};
