import{reactive as e,provide as t,h as n,inject as o,watch as i,nextTick as a,onMounted as l,ref as r}from"vue";const s={Map:{name:"Map",props:{name:{type:String,default:()=>"AMap"},zoom:{type:Number,default:()=>13},center:{type:Array,default:()=>[116.397428,39.90923]},viewMode:{type:String,default:"2D"},id:{type:String,default:"MapDom"}},setup(o,i){const a=e({map:{},isReady:!1});return t("storeData",a),function(){let e="";if("AMap"===o.name)e="https://webapi.amap.com/maps?v=2.1Beta&key=966a1cec27bf619fc0b3d8683e8f4c01&plugin=AMap.MarkerCluster";(t=o.name,n=e,window[t]?window[t]._preloader?window[t]._preloader:Promise.resolve(window[t]):(window[t]={},window[t]._preloader=new Promise((function(e,o){window._initMap=function(){e(window[t]),window[t]._preloader=null,window._initMap=null};var i=document.createElement("script");i.type="text/javascript",window.document.body.appendChild(i),i.src=n+"&callback=_initMap"})),window[t]._preloader)).then((e=>{!function(e){a.map=new e.Map(o.id,{zoom:o.zoom,center:o.center,viewMode:o.viewMode}),a.isReady=!0}(e)}));var t,n}(),()=>n("div",{class:"Map",id:o.id,style:{height:"500px"}},n("div",{},a.isReady&&i.slots.default?i.slots.default():""))}},Marker:{name:"Marker",props:{position:{type:Array,default:()=>[]},size:{type:Array,default:()=>[32,32]},id:null,Icon:{type:String||null,default:null},usemoveTransform:{type:Boolean,default:()=>!1}},emits:["click","moving"],setup(e,t){const n=o("storeData"),{map:l}=n;let r=null;function s(){e.position.length&&(console.log(e.size,"initMakrt"),r=new window.AMap.Marker({map:l,position:e.position,icon:e.Icon,size:new window.AMap.Size(e.size[0],e.size[1])}),r.id=e.id,r.on("click",d),r.on("moving",u))}function p(){console.log("removeMarker"),r&&(r.off("click",d),r.off("moving",u),l.remove(r),r=null)}function d(n){t.emit("click",{id:e.id,lnglat:e.position})}function u(n){t.emit("moving",{id:e.id,lnglat:n.target._position})}return s(),i((()=>e.position),(function(t){if(!r)return s();if(!t.length)return p();!function(t,n=1e3){console.log(t,"setPosition"),e.usemoveTransform?r.moveTo(t,{duration:n,delay:500}):r.setPosition(t)}(t)}),{immediate:!0,deep:!0}),i((()=>e.Icon),(function(e,t){if(!r)return;e!=t&&r.setIcon(e)}),{immediate:!0,deep:!0}),a((()=>{})),{removeMarker:p,myMarker:r}},render:()=>()=>n("div",{class:"Marker"},"Marker")},Liner:{name:"Liner",props:{path:{type:Array,default:()=>[]},options:{type:Object,default:()=>({borderWeight:2,strokeColor:"#28F"})}},setup(e){const t=o("storeData");console.log(t,"storeData");const{map:a}=t;var l=null;function r(e,t){console.log(e,t,"val,e")}return(l=new window.AMap.Polyline({map:a,...e.options})).on("click",r),i((()=>e.path),(function(t){t.length&&l.setPath(e.path)}),{immediate:!0,deep:!0}),()=>n("div",{class:"Liner"},"Liner")}},InfoWindow:{name:"InfoWindow",props:{position:{type:Array,default:()=>[]},content:null},emits:["close"],setup(e,t){const n=o("storeData"),{map:a}=n;let r=null;function s(){e.position.length?t.emit("close"):console.log("手动调用")}function p(){r.setContent(e.content)}return r=new window.AMap.InfoWindow({offset:new window.AMap.Pixel(0,-30),autoMove:!0}),r.id=e.id,r.on("close",s),l((()=>{console.log("InfoWindow")})),i((()=>e.position),(function(t){r&&t.length&&(r.getIsOpen()?(n=t,p(),r.setPosition(n)):(p(),r.open(a,e.position)));var n}),{immediate:!0,deep:!0}),i((()=>e.content),(function(e){r.setContent(e)}),{immediate:!0,deep:!0}),{close:function(){r.close()}}},render:()=>()=>n("div",{class:"InfoWindow"},"InfoWindow")},MouseTool:{name:"MouseTool",props:{type:{type:String,default:"marker"}},emits:["draw"],setup(e,t){const n=o("storeData"),{map:a}=n;var l=r(),s=[];function p(n){console.log(e.type,n),s.push(n.obj),t.emit("draw",{obj:n.obj,overlays:s})}return a.plugin(["AMap.MouseTool"],(function(){l.value=new window.AMap.MouseTool(a)})),i((()=>e.type),(function(e){console.log(e,"watchType"),e&&e!=l.value&&(l.value[e](),l.value.on("draw",p))}),{immediate:!0,deep:!0}),{remove:function(){a.remove(s)},close:function(e=!0){l.value.close(e)}}},render:()=>()=>n("div",{class:"MouseTool"},"MouseTool")},PathSimplifierIns:{name:"PathSimplifierIns",props:{model:{type:String,default:()=>"realTime"},icon:{type:String||null,default:""},id:null,position:{type:Array,default:()=>[]}},emits:["moveing","pointClick"],setup(e,t){const a=o("storeData");console.log(a,"storeData");const{map:r}=a;var s=null,p=null;const d={lineWidth:0,fillStyle:null,strokeStyle:null,borderStyle:null};var u,c,m=null,f=[{name:"动态路线",path:[[]]}],w=0;function v(){s=new p({zIndex:100,autoSetFitView:!1,map:r,pathNavigatorStyle:{width:32,height:32,content:p.Render.Canvas.getImageContent(e.icon)},getPath:function(e){return e.path},getHoverTitle:function(e){return e.name+"，点数量"+e.path.length},renderOptions:"realTime"==e.model?{pathLineStyle:d,pathLineSelectedStyle:d,pathLineHoverStyle:d,keyPointStyle:d,startPointStyle:d,endPointStyle:d,keyPointHoverStyle:d,keyPointOnSelectedPathLineStyle:d}:{}})}function g(n,o){let i=o.dataItem.pointIndex,a=m.getPosition();if(t.emit("moveing",[a.lng,a.lat]),"realTime"==e.model);else{if(!e.position[w].icon)return;if(w!=i){w=i,m.getStyleOptions().content=p.Render.Canvas.getImageContent(e.position[w].icon),s.renderLater(200)}}}function y(e,n){t.emit("pointClick",e,n)}function h(t){s?"realTime"==e.model?m?function(t){if(t.length){var n=m.getCursor().clone(),o=m.getNaviStatus();f[0].path[0].length?f[0].path.push(t):f[0].path[0]=t,s.setData(f),(m=s.createPathNavigator(0,{speed:1e6,pathNavigatorStyle:{width:32,height:32,content:p.Render.Canvas.getImageContent(e.icon)}})).on("move",g),"stop"!==o&&m.start(),n.idx>=0&&m.moveToPoint(n.idx,n.tail)}}(t):(f[0].path[0]=e.position,s.setData(f),(m=s.createPathNavigator(0,{speed:1e6,loop:!1,pathNavigatorStyle:{width:32,height:32,content:p.Render.Canvas.getImageContent(e.icon)}})).start()):function(){let t=[];if(e.position[0].point&&(t=e.position.map((e=>e.point))),e.position[0].length&&(t=e.position),console.log(t,"historyStart"),t[0]){let n=e.position[0].icon||e.icon;console.log(e.position,"historyStart"),f[0].path=t,s.setData(f),(m=s.createPathNavigator(0,{loop:!1,speed:1e6,pathNavigatorStyle:{width:32,height:32,content:p.Render.Canvas.getImageContent(n)},getPath:function(e){return e.path}})).start(),m.on("move",g),s.off("pathClick pointClick",y)}}():setTimeout((()=>{"realTime"==e.model?h(t):h(null)}),200)}return(u="AMapUI",c="https://webapi.amap.com/ui/1.1/main.js?v=1.1.1",window[u]?window[u]._preloader?window[u]._preloader:Promise.resolve(window[u]):(window[u]={},window[u]._preloader=new Promise(((e,t)=>{const n=document.createElement("script");n.src=c,window.document.body.appendChild(n),n.onload=function(){e(window[u]),window[u]._preloader=null}})),window[u]._preloader)).then((e=>{!function(e){e.load(["ui/misc/PathSimplifier"],(function(e){e.supportCanvas?(p=e,v()):alert("当前环境不支持 Canvas！")}))}(e)})),l((()=>{})),i((()=>e.id),(function(t,n){if(!n)return;m&&m.destroy(),m=null,"realTime"==e.model&&t&&(f[0].path=[e.position],v())}),{immediate:!0,deep:!0}),i((()=>e.position),(function(e){if(!e[0])return;h(e)}),{immediate:!0,deep:!0}),()=>n("div",{class:"PathSimplifierIns"},"PathSimplifierIns")}},MoveAnimation:{name:"MoveAnimation",props:{lineArr:{type:Array,default:()=>[]}},setup(e,t){const n=o("storeData"),{map:a}=n;var l=null;return i((()=>e.lineArr),(function(t){t[0]&&(console.log(e.lineArr[0],"props.lineArr"),window.AMap.plugin("AMap.MoveAnimation",(function(){l=new window.AMap.Marker({map:a,position:e.lineArr[0],icon:"https://a.amap.com/jsapi_demos/static/demo-center-v2/car.png"});let t=new window.AMap.Polyline({map:a,strokeColor:"#AF5",strokeWeight:6});l.on("moving",(function(e){t.setPath(e.passedPath)})),a.setFitView()})))}),{immediate:!0,deep:!0}),{startAnimation:function(){l.moveAlong(e.lineArr,{duration:500,autoRotation:!0})},pauseAnimation:function(){l.pauseMove()},resumeAnimation:function(){l.resumeMove()},stopAnimation:function(){l.stopMove()}}},render:()=>()=>n("div",{class:"MoveAnimation"},"MoveAnimation")},EditPlugin:{name:"EditPlugin",props:{type:{type:String,default:""},edit:{type:Boolean,default:!1},overlayOptions:{type:Object,default:()=>({})}},emits:["end"],setup(e,t){const n=o("storeData"),{map:a}=n;var l="",r=null,s=null;function p(){console.log(l,"createOverlayeditType Circle");let t={};"rectangle"==e.type&&(t.bounds=new window.AMap.Bounds(e.overlayOptions.southWest,e.overlayOptions.northEast)),(r=new window.AMap[l]({...e.overlayOptions,...t})).setMap(a),e.edit&&d()}function d(){if("marker"==e.type)return r.setDraggable(!0);a.plugin(["AMap."+l+"Editor"],(function(){(s=new window.AMap[l+"Editor"](a,r)).open(),s.on("end",u)}))}function u(e){t.emit("end",e)}i((()=>e.edit),(function(t){if(!e.type)return;t?r?d():p():s&&s.close()}),{immediate:!0,deep:!0}),i((()=>e.type),(function(e){if(function(){r&&(a.remove(r),r=null);s&&(s.close(),s.off("end",u),s=null)}(),e){let t=e.split("");t[0]=t[0].toUpperCase(),l=t.join(""),p()}}),{immediate:!0,deep:!0})},render:()=>()=>n("div",{class:"EditPlugin"},"EditPlugin")}};console.log(s,"modules");let p={version:"0.1.0",install:function(e){for(var t in s)e.component(t,s[t])},...s};export{p as default};
